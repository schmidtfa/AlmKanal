### Preprocessing
{# --- shared reference namespace (per render) --- #}
{% set refns = namespace(order=[], nums={}, texts={}) %}
{# --- macro: cite a reference by key; provide full text on first use --- #}
{% macro ref(key, text=None) -%}
  {%- if key not in refns.nums %}
    {# first time we see this key → assign next number and store text #}
    {% do refns.order.append(key) %}
    {% do refns.nums.update({key: refns.order|length}) %}
    {% do refns.texts.update({key: text}) %}
  {%- else %}
    {# seen before → if text was missing and provided now, store it #}
    {%- if (refns.texts[key] is none) and (text is not none) %}
      {% do refns.texts.update({key: text}) %}
    {%- endif %}
  {%- endif -%}
  {{ refns.nums[key] }}
{%- endmacro %}

{# --- render steps; partials can call {{ ref('Key', 'Full citation…') }} --- #}
{% for s in steps -%}
{% include ["steps/" ~ s.name ~ ".j2", "steps/default.j2"] %}
{% endfor %}

{# --- References section (deduped, in order of first appearance) --- #}
{% if refns.order %}

### References
{% for key in refns.order -%}
{{ refns.nums[key] }}. {{ refns.texts[key] if refns.texts[key] is not none else key }}
{% endfor %}
{% endif %}

